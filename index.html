<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pithos | Dungeon OS</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- MONOCHROME THEME --- */
        :root { --bg: #000; --fg: #fff; --dim: #666; --border: 1px solid #fff; --active: 2px solid #fff; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--fg); font-family: 'JetBrains Mono', monospace; height: 100dvh; overflow: hidden; user-select: none; }
        
        .hidden { display: none !important; }
        
        /* SCREENS */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: #000; z-index: 10; }
        
        /* LOADER */
        #screen-loader { align-items: center; justify-content: center; z-index: 100; cursor: pointer; }
        .loading-bar { width: 150px; height: 2px; background: #333; margin-top: 15px; position: relative; overflow: hidden; }
        .loading-bar::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 50%; background: #fff; animation: load 1s infinite ease-in-out; }
        @keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

        /* AUTH */
        #screen-auth { align-items: center; justify-content: center; z-index: 50; }
        .auth-box { width: 300px; text-align: center; }
        .auth-input { background: transparent; border: none; border-bottom: 1px solid var(--dim); color: var(--fg); font-size: 1.2rem; padding: 10px; width: 100%; margin-bottom: 20px; text-align: center; outline: none; font-family: inherit; }
        .auth-input:focus { border-color: #fff; }
        #pattern-container { margin: 20px auto; width: 260px; height: 260px; border: 1px dashed #333; position: relative; }

        /* MAIN UI */
        #screen-main { z-index: 20; }
        .top-bar { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #333; flex-shrink: 0; }
        .workspace { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .bottom-nav { display: flex; border-top: 1px solid #333; flex-shrink: 0; height: 60px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border-right: 1px solid #333; color: #666; transition: 0.2s; font-size: 0.8rem; }
        .nav-item:last-child { border-right: none; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .nav-item.active { background: #fff; color: #000; }

        /* MODULES & WINDOWS */
        .module { display: none; animation: fadeIn 0.3s; }
        .module.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .window { border: 1px solid #fff; padding: 20px 15px; margin-bottom: 20px; position: relative; }
        .win-title { position: absolute; top: -10px; left: 10px; background: #000; padding: 0 5px; font-weight: bold; font-size: 0.8rem; }

        /* ELEMENTS */
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #444; padding: 5px 0; font-size: 0.9rem; }
        .btn { border: 1px solid #fff; background: #000; color: #fff; padding: 12px; cursor: pointer; font-weight: bold; text-align: center; width: 100%; display: block; font-family: inherit; }
        .btn:active { background: #333; }
        .btn:hover { background: #fff; color: #000; }
        
        input[type="text"], input[type="number"], select { 
            background: #000; color: #fff; border: 1px solid #666; padding: 10px; width: 100%; 
            margin-bottom: 15px; font-family: inherit; outline: none; border-radius: 0; 
        }
        input:focus { border-color: #fff; }
        label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 5px; }

        /* QUEST & DUNGEON */
        .quest-card { border: 1px solid #444; padding: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .quest-card:hover { border-color: #fff; }
        .q-title { font-weight: bold; }
        .q-reward { float: right; color: #ccc; }

        .hp-frame { width: 100%; border: 1px solid #444; height: 20px; margin: 15px 0; position: relative; }
        .hp-fill { height: 100%; background: #fff; width: 0%; transition: width 0.3s; }
        .hp-text { position: absolute; top: 0; left: 5px; font-size: 0.7rem; line-height: 18px; color: #888; mix-blend-mode: difference; }

        .enemy-row { display: flex; justify-content: space-between; padding: 12px; border: 1px solid #333; margin-bottom: 8px; cursor: pointer; align-items: center; }
        .enemy-row.defeated { text-decoration: line-through; opacity: 0.5; }
        
        .log-box { height: 100px; overflow-y: auto; border: 1px dashed #333; padding: 5px; font-size: 0.7rem; color: #888; margin-top: 15px; }
        
        /* TACTICAL COMMS */
        .sig-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .sig-btn { border: 1px solid #444; background: #000; color: #888; padding: 8px; cursor: pointer; font-size: 0.8rem; }
        .sig-btn:active { background: #fff; color: #000; }

        /* MODAL */
        #report-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal { background: #000; border: 2px solid #fff; padding: 20px; width: 85%; max-width: 400px; }
    </style>

    <script>
        // NOSTR BRIDGE
        let sk=null, pk=null; 
        const relays=['wss://relay.damus.io','wss://nos.lol'];
        
        function js_set_key(hex){ 
            try { sk=hex; pk=window.NostrTools.getPublicKey(sk); return pk; } 
            catch(e){ console.error(e); return null; } 
        }
        
        async function js_pub(k,c,t){ 
            if(!sk) return; 
            const e={kind:k,pubkey:pk,created_at:Math.floor(Date.now()/1000),tags:t,content:c}; 
            e.id=window.NostrTools.getEventHash(e); 
            e.sig=window.NostrTools.signEvent(e,sk); 
            const p=new window.NostrTools.SimplePool(); 
            p.publish(relays,e); 
            return e.id; 
        }

        // UI SWITCHER
        function switchTab(id){
            document.querySelectorAll('.module').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('mod-'+id).classList.add('active');
            document.getElementById('tab-'+id).classList.add('active');
        }

        function forceStart(){
            document.getElementById('screen-loader').classList.add('hidden');
            document.getElementById('screen-auth').classList.remove('hidden');
        }
    </script>
</head>
<body>

    <!-- 0. LOADER -->
    <div id="screen-loader" class="screen" onclick="forceStart()">
        <div style="font-size:0.8rem; letter-spacing:2px;">SYSTEM BOOT...</div>
        <div class="loading-bar"><div></div></div>
        <div style="margin-top:20px; font-size:0.6rem; color:#444;">(Tap if frozen)</div>
    </div>

    <!-- 1. AUTH -->
    <div id="screen-auth" class="screen hidden">
        <div class="auth-box">
            <div style="font-size:1.5rem; margin-bottom:20px; border-bottom:1px solid #fff; display:inline-block;">LOGIN</div>
            <input type="text" id="in-name" class="auth-input" placeholder="NAME (ÂêçÂâç)" autocomplete="off">
            <input type="text" id="in-word" class="auth-input" placeholder="WORD (‰ø°Âøµ)" autocomplete="off">
            
            <div style="font-size:0.7rem; color:#666;">DRAW SIGIL (Âç∞)</div>
            <div id="pattern-container">
                <canvas id="lock-canvas" width="260" height="260"></canvas>
            </div>
        </div>
    </div>

    <!-- 2. MAIN -->
    <div id="screen-main" class="screen hidden">
        <div class="top-bar">
            <div><span id="disp-name">GUEST</span> <span style="font-size:0.8rem; color:#666;" id="disp-job">LV.1</span></div>
            <div style="font-size:0.8rem;">PITHOS v2.6</div>
        </div>

        <div class="workspace">
            
            <!-- HOME MODULE -->
            <div id="mod-home" class="module active">
                <div class="window">
                    <div class="win-title">STATUS</div>
                    <div class="stat-row"><span>STR (Strength)</span><span id="st-str">?</span></div>
                    <div class="stat-row"><span>INT (Intellect)</span><span id="st-int">?</span></div>
                    <div class="stat-row"><span>DEX (Dexterity)</span><span id="st-dex">?</span></div>
                    <div class="stat-row" style="border:none; padding-top:10px;">
                        <span>CAPACITY</span><span>¬•30,000,000</span>
                    </div>
                </div>
                <div class="window">
                    <div class="win-title">SYSTEM LOG</div>
                    <div id="sys-log" style="height:100px; overflow-y:auto; font-size:0.7rem; color:#888;">
                        > Ready.<br>
                    </div>
                </div>
            </div>

            <!-- QUEST MODULE -->
            <div id="mod-quest" class="module">
                
                <!-- LIST VIEW -->
                <div id="view-qlist">
                    <div class="window">
                        <div class="win-title">QUEST BOARD</div>
                        <div id="quest-container">
                            <!-- Python injects quests here -->
                        </div>
                    </div>
                    <button class="btn" py-click="add_demo_quest">Ôºã REFRESH BOARD</button>
                </div>

                <!-- DUNGEON VIEW -->
                <div id="view-dungeon" class="hidden">
                    <div class="window" style="border:2px solid #fff;">
                        <div class="win-title">MISSION IN PROGRESS</div>
                        <h2 id="dun-name" style="margin:5px 0;">...</h2>
                        
                        <div class="hp-frame">
                            <div id="dun-hp" class="hp-fill"></div>
                            <div class="hp-text">PROGRESS <span id="dun-pct">0</span>%</div>
                        </div>

                        <!-- Tasks -->
                        <div style="margin: 20px 0;">
                            <div class="win-title" style="position:static; background:none; margin-bottom:5px;">TASKS (ENEMIES)</div>
                            <div id="task-list">
                                <!-- Python injects tasks here -->
                            </div>
                        </div>

                        <!-- Comms -->
                        <div class="sig-grid">
                            <button class="sig-btn" py-click="lambda e: send_sig('üìç ARRIVED')">üìç ARRIVED</button>
                            <button class="sig-btn" py-click="lambda e: send_sig('üî® WORKING')">üî® WORKING</button>
                            <button class="sig-btn" py-click="lambda e: send_sig('‚úÖ DONE')">‚úÖ DONE</button>
                            <button class="sig-btn" py-click="lambda e: send_sig('üÜò SOS')">üÜò SOS</button>
                        </div>

                        <div class="log-box" id="battle-log">
                            <div>> Mission Started.</div>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button class="btn" py-click="exit_dungeon" style="border-color:#666; color:#666;">ABORT</button>
                            <button class="btn" id="btn-claim" style="display:none;" py-click="claim_reward">üí∞ CLAIM</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUDIT MODULE -->
            <div id="mod-audit" class="module">
                <div class="window">
                    <div class="win-title">DISTORTION SCANNER</div>
                    <label>TARGET NAME</label><input type="text" id="a-target" placeholder="‰æã: ÈßÖÂâç„É¢„Éã„É•„É°„É≥„Éà">
                    <label>BUDGET (JPY)</label><input type="number" id="a-budget" placeholder="30000000">
                    <label>USERS (DAILY)</label><input type="number" id="a-users" placeholder="5">
                    <button class="btn" py-click="audit">SCAN & REPORT</button>
                </div>
                <div id="a-res" style="text-align:center; font-size:1.5rem; margin-top:20px;">---</div>
            </div>

        </div>

        <!-- NAV -->
        <div class="bottom-nav">
            <div id="tab-home" class="nav-item active" onclick="switchTab('home')"><i class="fas fa-id-card"></i>STATUS</div>
            <div id="tab-quest" class="nav-item" onclick="switchTab('quest')"><i class="fas fa-dungeon"></i>QUEST</div>
            <div id="tab-audit" class="nav-item" onclick="switchTab('audit')"><i class="fas fa-eye"></i>AUDIT</div>
        </div>
    </div>

    <!-- REPORT MODAL -->
    <div id="report-overlay">
        <div class="modal">
            <div style="font-weight:bold; margin-bottom:10px;">BATTLE REPORT</div>
            <p id="rep-task-name" style="font-size:0.8rem; color:#888;">...</p>
            <input type="text" id="rep-msg" placeholder="REPORT / EVIDENCE URL">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="border-color:#666; color:#666;" onclick="document.getElementById('report-overlay').style.display='none'">CANCEL</button>
                <button class="btn" py-click="submit_report">ATTACK</button>
            </div>
        </div>
    </div>

    <!-- JS: SIGIL LOGIC -->
    <script>
        let pPath=[], isD=false; 
        const cvs=document.getElementById('lock-canvas'), ctx=cvs.getContext('2d');
        const dots=[]; 
        for(let r=0;r<3;r++) for(let c=0;c<3;c++) dots.push({x:30+c*100,y:30+r*100,id:r*3+c});

        function dr(){ 
            ctx.clearRect(0,0,260,260); 
            if(pPath.length>1){
                ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle='#fff'; 
                ctx.moveTo(dots[pPath[0]].x, dots[pPath[0]].y); 
                for(let i=1;i<pPath.length;i++) ctx.lineTo(dots[pPath[i]].x, dots[pPath[i]].y); 
                ctx.stroke();
            }
            dots.forEach(d=>{ 
                ctx.beginPath(); ctx.fillStyle=pPath.includes(d.id)?'#fff':'#333'; 
                ctx.arc(d.x,d.y, pPath.includes(d.id)?6:3, 0,Math.PI*2); ctx.fill(); 
            }); 
        }
        
        function proc(e){
            e.preventDefault(); // Stop scroll
            const r=cvs.getBoundingClientRect();
            const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
            const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
            const d=dots.find(dt=>Math.hypot(dt.x-x,dt.y-y)<30);
            if(d && !pPath.includes(d.id)){ pPath.push(d.id); dr(); }
        }

        const start=e=>{isD=true;pPath=[];proc(e)};
        const move=e=>{if(isD)proc(e)};
        const end=e=>{
            isD=false; 
            if(pPath.length>=4) window.onSigil(document.getElementById('in-name').value, document.getElementById('in-word').value, pPath.join("-")); 
            else {pPath=[];dr();}
        };

        cvs.addEventListener('mousedown',start); cvs.addEventListener('touchstart',start);
        cvs.addEventListener('mousemove',move); cvs.addEventListener('touchmove',move);
        cvs.addEventListener('mouseup',end); cvs.addEventListener('touchend',end);
        dr();
    </script>

    <!-- PYTHON LOGIC -->
    <script type="py">
        from pyscript import document
        from pyodide.ffi import create_proxy
        import js, hashlib
        from datetime import datetime

        # --- GLOBAL VARIABLES ---
        current_tasks = []
        active_task_id = -1
        active_quest_title = ""
        quests = [
            {"title": "BRIDGE REPAIR", "reward": 50000},
            {"title": "DATA CLEANING", "reward": 20000},
        ]

        # --- UTILS ---
        def log(msg, target="sys-log"):
            t = datetime.now().strftime('%H:%M')
            c = document.getElementById(target)
            if c: c.innerHTML = f"<div>[{t}] {msg}</div>" + c.innerHTML

        def boot():
            # Signal Python is ready
            document.getElementById('screen-loader').classList.add('hidden')
            document.getElementById('screen-auth').classList.remove('hidden')

        # --- AUTH HANDLER ---
        def on_sigil_py(name, word, pattern):
            if not name: return
            seed = f"SBCM_{name}_{word}_{pattern}"
            pk_hex = hashlib.sha256(seed.encode()).hexdigest()
            pub = js.js_set_key(pk_hex)
            
            if pub:
                document.getElementById('screen-auth').classList.add('hidden')
                document.getElementById('screen-main').classList.remove('hidden')
                
                # Stats
                val = int(pk_hex[:8], 16)
                document.getElementById('disp-name').innerText = name.upper()
                
                # RPG Classes
                role = "CITIZEN"
                if val % 3 == 0: role = "WARRIOR"
                elif val % 3 == 1: role = "WIZARD"
                else: role = "RANGER"
                document.getElementById('disp-job').innerText = role

                document.getElementById('st-str').innerText = (val % 10) + 1
                document.getElementById('st-int').innerText = ((val >> 4) % 10) + 1
                document.getElementById('st-dex').innerText = ((val >> 8) % 10) + 1
                
                render_quests()
                log(f"LOGIN: {name} ({role})")

        js.window.onSigil = create_proxy(on_sigil_py)

        # --- QUEST BOARD ---
        def render_quests():
            c = document.getElementById("quest-container")
            c.innerHTML = ""
            for q in quests:
                div = document.createElement("div")
                div.className = "quest-card"
                div.innerHTML = f"<span class='q-title'>{q['title']}</span><span class='q-reward'>¬•{q['reward']:,}</span>"
                # Bind click
                div.onclick = lambda e, t=q['title']: init_dungeon(t)
                c.appendChild(div)

        def add_demo_quest(e):
            quests.insert(0, {"title": "EMERGENCY JOB", "reward": 80000})
            render_quests()

        # --- DUNGEON LOGIC ---
        def init_dungeon(title):
            global current_tasks, active_quest_title
            active_quest_title = title
            current_tasks = [
                {"id": 0, "name": "AREA SURVEY", "done": False},
                {"id": 1, "name": "MAIN WORK", "done": False},
                {"id": 2, "name": "FINAL REPORT", "done": False}
            ]
            
            document.getElementById('view-qlist').classList.add('hidden')
            document.getElementById('view-dungeon').classList.remove('hidden')
            document.getElementById('dun-name').innerText = title
            
            # Reset UI
            document.getElementById('btn-claim').style.display = 'none'
            document.getElementById("battle-log").innerHTML = "<div>> MISSION START.</div>"
            
            render_tasks()

        def render_tasks():
            c = document.getElementById("task-list")
            c.innerHTML = ""
            done_count = 0
            
            for t in current_tasks:
                div = document.createElement("div")
                if t["done"]:
                    div.className = "enemy-row defeated"
                    div.innerHTML = f"<span>{t['name']}</span><span>[DEFEATED]</span>"
                    done_count += 1
                else:
                    div.className = "enemy-row"
                    div.innerHTML = f"<span>{t['name']}</span><span>[ALIVE]</span>"
                    # Click to open report modal
                    div.onclick = lambda e, tid=t["id"], nm=t["name"]: open_report(tid, nm)
                c.appendChild(div)

            # Progress
            pct = int((done_count / len(current_tasks)) * 100)
            document.getElementById("dun-hp").style.width = f"{pct}%"
            document.getElementById("dun-pct").innerText = pct
            
            if pct >= 100:
                document.getElementById('btn-claim').style.display = 'block'
                log("BOSS DEFEATED. CLAIM REWARD.", "battle-log")

        def open_report(tid, name):
            global active_task_id
            active_task_id = tid
            document.getElementById('rep-task-name').innerText = f"TARGET: {name}"
            document.getElementById('rep-msg').value = ""
            document.getElementById('report-overlay').style.display = 'flex'

        async def submit_report(e):
            msg = document.getElementById('rep-msg').value
            if not msg: msg = "No details"
            
            # Update State
            current_tasks[active_task_id]["done"] = True
            document.getElementById('report-overlay').style.display = 'none'
            
            render_tasks()
            log(f"HIT! TASK {active_task_id} -> {msg}", "battle-log")
            
            # Send to Nostr
            await js.js_pub(1, f"PROGRESS: {active_quest_title}\nTASK:{active_task_id} DONE\nNOTE:{msg}", [["t","SBCM_PROG"]])

        def exit_dungeon(e):
            document.getElementById('view-dungeon').classList.add('hidden')
            document.getElementById('view-qlist').classList.remove('hidden')

        async def claim_reward(e):
            log("REWARD CLAIMED.", "battle-log")
            await js.js_pub(1, f"CLAIM: {active_quest_title} COMPLETE", [["t","SBCM_CLAIM"]])
            exit_dungeon(None)

        # --- COMMS ---
        async def send_sig(sig):
            log(f"SIG: {sig}", "battle-log")
            await js.js_pub(1, f"SIGNAL: {sig}", [["t","SBCM_SIG"]])

        # --- AUDIT ---
        async def audit(e):
            try:
                b = float(document.getElementById("a-budget").value)
                u = float(document.getElementById("a-users").value)
                t = document.getElementById("a-target").value
                
                if u == 0: u = 1
                d = b/30000000/(u/72000)
                res = "SCAM" if d > 10 else "SAFE"
                
                document.getElementById("a-res").innerText = f"D: {d:.1f} [{res}]"
                
                await js.js_pub(1, f"AUDIT: {t}\nD:{d:.1f}\n#{res}", [["t","SBCM_AUDIT"]])
                log(f"AUDIT SENT: {res}")
            except:
                log("INPUT ERROR")

        # Ready
        boot()
    </script>
</body>
</html>