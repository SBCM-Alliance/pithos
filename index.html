<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pithos | Dungeon Manager</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- MONOCHROME THEME --- */
        :root { --bg: #000; --fg: #fff; --dim: #666; --border: 1px solid #fff; --active: 2px solid #fff; }
        body { margin: 0; background: var(--bg); color: var(--fg); font-family: 'JetBrains Mono', monospace; height: 100dvh; overflow: hidden; user-select: none; }
        
        .hidden { display: none !important; }
        .blink { animation: blink 1s infinite step-end; }
        @keyframes blink { 50% { opacity: 0; } }

        /* LOADER & AUTH (Standard) */
        #screen-loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; position: absolute; width: 100%; background: #000; z-index: 99; }
        .loading-bar { width: 100px; height: 2px; background: #333; margin-top: 10px; } .loading-bar div { height: 100%; width: 50%; background: #fff; animation: load 1s infinite; } @keyframes load { 0% { margin-left: -50%; } 100% { margin-left: 100%; } }
        #screen-void { display: none; align-items: center; justify-content: center; height: 100%; font-size: 1.2rem; cursor: pointer; }
        #screen-auth { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .auth-input { background: transparent; border: none; border-bottom: 1px solid var(--dim); color: var(--fg); font-size: 1.2rem; padding: 10px; width: 280px; margin-bottom: 30px; text-align: center; outline: none; }
        #pattern-container { margin-top: 20px; border: 1px dashed #333; }

        /* MAIN UI */
        #screen-main { display: none; height: 100%; display: flex; flex-direction: column; }
        .top-bar { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #333; }
        .workspace { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .bottom-nav { display: flex; border-top: 1px solid #333; }
        .nav-item { flex: 1; text-align: center; padding: 15px 0; cursor: pointer; border-right: 1px solid #333; }
        .nav-item.active { background: #fff; color: #000; }

        /* WINDOWS */
        .window { border: 1px solid #fff; padding: 15px; margin-bottom: 15px; position: relative; }
        .win-title { position: absolute; top: -10px; left: 10px; background: #000; padding: 0 5px; font-weight: bold; font-size: 0.8rem; }

        /* RPG ELEMENTS */
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #444; padding: 5px 0; }
        .btn { border: 1px solid #fff; background: #000; color: #fff; padding: 10px; cursor: pointer; font-weight: bold; text-align: center; width: 100%; box-sizing: border-box; }
        .btn:hover { background: #fff; color: #000; }
        input { background: #000; color: #fff; border: 1px solid #666; padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }

        /* --- DUNGEON & PROGRESS --- */
        .hp-bar-frame { width: 100%; border: 1px solid #444; height: 15px; margin: 10px 0; position: relative; }
        .hp-bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.3s; }
        .hp-text { position: absolute; top: 0; left: 5px; font-size: 0.7rem; line-height: 15px; color: #888; mix-blend-mode: difference; }

        .enemy-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; border: 1px solid #333; margin-bottom: 5px; cursor: pointer; 
        }
        .enemy-row:hover { border-color: #fff; }
        .enemy-row.defeated { opacity: 0.5; text-decoration: line-through; border-color: #222; }
        
        .battle-log { 
            height: 100px; overflow-y: auto; border: 1px dashed #333; 
            padding: 5px; font-size: 0.7rem; color: #888; margin-top: 10px; 
        }
        .log-line { margin-bottom: 2px; }

        /* REPORT MODAL (Simple overlay) */
        #report-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 50; display: none;
            align-items: center; justify-content: center;
        }
        .modal-box { width: 80%; border: 2px solid #fff; padding: 20px; background: #000; }

        /* TACTICAL COMMS */
        .sig-row { display: flex; gap: 5px; margin-top: 10px; }
        .sig-btn { flex: 1; border: 1px solid #444; background: #000; color: #888; padding: 5px; font-size: 0.7rem; cursor: pointer; }
        .sig-btn:hover { border-color: #fff; color: #fff; }

    </script>
    <script>
        // Bridge
        let sk=null, pk=null; const relays=['wss://relay.damus.io'];
        function js_set_key(hex){ try{sk=hex; pk=window.NostrTools.getPublicKey(sk); return pk;}catch{return null;} }
        async function js_pub(k,c,t){ if(!sk)return; const e={kind:k,pubkey:pk,created_at:Math.floor(Date.now()/1000),tags:t,content:c}; e.id=window.NostrTools.getEventHash(e); e.sig=window.NostrTools.signEvent(e,sk); (new window.NostrTools.SimplePool()).publish(relays,e); return e.id; }
        function switchTab(id){ document.querySelectorAll('.module').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('mod-'+id).classList.remove('hidden'); document.getElementById('tab-'+id).classList.add('active'); }
        function forceStart(){ document.getElementById('screen-loader').style.display='none'; }
    </script>
</head>
<body>

    <!-- 0. LOADER -->
    <div id="screen-loader" onclick="forceStart()"><div>SYSTEM LOADING...</div><div class="loading-bar"><div></div></div></div>
    <!-- 1. AUTH -->
    <div id="screen-auth" class="hidden">
        <div class="window" style="width:280px;">
            <div class="win-title">LOGIN</div>
            <input type="text" id="in-name" class="auth-input" placeholder="NAME">
            <input type="text" id="in-word" class="auth-input" placeholder="WORD">
            <div id="pattern-container"><canvas id="lock-canvas" width="260" height="260"></canvas></div>
        </div>
    </div>

    <!-- 3. MAIN -->
    <div id="screen-main" class="hidden">
        <div class="top-bar">
            <div><span id="disp-name">GUEST</span> <span style="font-size:0.8rem; color:#666;">LV.1</span></div>
            <div id="disp-job">...</div>
        </div>

        <div class="workspace">
            
            <!-- HOME -->
            <div id="mod-home" class="module">
                <div class="window">
                    <div class="win-title">STATUS</div>
                    <div class="stat-row"><span>STR</span><span id="st-str">?</span></div>
                    <div class="stat-row"><span>INT</span><span id="st-int">?</span></div>
                    <div class="stat-row"><span>DEX</span><span id="st-dex">?</span></div>
                </div>
            </div>

            <!-- QUEST / DUNGEON -->
            <div id="mod-quest" class="module hidden">
                
                <!-- LIST VIEW -->
                <div id="view-qlist">
                    <div class="window">
                        <div class="win-title">QUEST BOARD</div>
                        <div id="quest-list"><!-- Injected --></div>
                    </div>
                    <button class="btn" py-click="add_demo_quest">Ôºã REFRESH QUESTS</button>
                </div>

                <!-- DUNGEON VIEW (Progress Management) -->
                <div id="view-dungeon" class="hidden">
                    <div class="window" style="border-color:#fff;">
                        <div class="win-title">CURRENT MISSION</div>
                        <h2 id="dun-title" style="margin:5px 0;">...</h2>
                        
                        <!-- HP Bar (Progress) -->
                        <div class="hp-bar-frame">
                            <div id="dun-hp" class="hp-bar-fill"></div>
                            <div class="hp-text">PROGRESS <span id="dun-pct">0</span>%</div>
                        </div>

                        <!-- Tasks (Enemies) -->
                        <div style="margin: 15px 0;">
                            <div class="win-title" style="position:static; background:none; margin-bottom:5px;">ENEMIES (TASKS)</div>
                            <div id="task-list">
                                <!-- Python Injects Tasks Here -->
                            </div>
                        </div>

                        <!-- Battle Log -->
                        <div class="battle-log" id="battle-log">
                            <div class="log-line">> ENTERED DUNGEON.</div>
                        </div>

                        <!-- Tactical Comms -->
                        <div class="sig-row">
                            <button class="sig-btn" py-click="lambda e: send_sig('üìçARRIVED')">üìç ARRIVED</button>
                            <button class="sig-btn" py-click="lambda e: send_sig('üî® WORKING')">üî® WORKING</button>
                            <button class="sig-btn" py-click="lambda e: send_sig('üÜò SOS')">üÜò SOS</button>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:15px;">
                            <button class="btn" py-click="exit_dungeon" style="border-color:#666; color:#666;">RETREAT</button>
                            <button class="btn" id="btn-claim" style="display:none;" py-click="claim_reward">üí∞ CLAIM REWARD</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUDIT -->
            <div id="mod-audit" class="module hidden">
                <div class="window">
                    <div class="win-title">SCANNER</div>
                    <label>TARGET</label><input id="a-t"><label>COST</label><input id="a-b"><label>USER</label><input id="a-u">
                    <button class="btn" py-click="audit">SCAN</button>
                </div>
                <div id="a-res" style="text-align:center; font-size:1.5rem;">---</div>
            </div>

        </div>

        <div class="bottom-nav">
            <div id="tab-home" class="nav-item active" onclick="switchTab('home')"><i class="fas fa-user"></i></div>
            <div id="tab-quest" class="nav-item" onclick="switchTab('quest')"><i class="fas fa-dungeon"></i></div>
            <div id="tab-audit" class="nav-item" onclick="switchTab('audit')"><i class="fas fa-eye"></i></div>
        </div>
    </div>

    <!-- REPORT OVERLAY -->
    <div id="report-overlay">
        <div class="modal-box">
            <div class="win-title">BATTLE REPORT</div>
            <p id="rep-task-name">TASK NAME</p>
            <input type="text" id="rep-msg" placeholder="REPORT / PROOF URL">
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="document.getElementById('report-overlay').style.display='none'">CANCEL</button>
                <button class="btn" py-click="submit_report">ATTACK (SUBMIT)</button>
            </div>
        </div>
    </div>

    <!-- JS: SIGIL -->
    <script>
        let pPath=[], isD=false; const cvs=document.getElementById('lock-canvas'), ctx=cvs.getContext('2d');
        const dots=[]; for(let r=0;r<3;r++)for(let c=0;c<3;c++) dots.push({x:30+c*100,y:30+r*100,id:r*3+c});
        function dr(){ ctx.clearRect(0,0,260,260); if(pPath.length>1){ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle='#fff'; ctx.moveTo(dots[pPath[0]].x, dots[pPath[0]].y); for(let i=1;i<pPath.length;i++) ctx.lineTo(dots[pPath[i]].x, dots[pPath[i]].y); ctx.stroke();} dots.forEach(d=>{ ctx.beginPath(); ctx.fillStyle=pPath.includes(d.id)?'#fff':'#333'; ctx.arc(d.x,d.y, pPath.includes(d.id)?6:3, 0,Math.PI*2); ctx.fill(); }); }
        const mv=e=>{if(isD){e.preventDefault();const r=cvs.getBoundingClientRect();const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;const d=dots.find(dt=>Math.hypot(dt.x-x,dt.y-y)<30);if(d&&!pPath.includes(d.id)){pPath.push(d.id);dr();}}};
        const end=e=>{isD=false; if(pPath.length>=4)window.onSigil(document.getElementById('in-name').value,document.getElementById('in-word').value,pPath.join("-")); else{pPath=[];dr();}};
        cvs.addEventListener('mousedown',e=>{isD=true;pPath=[];mv(e)}); cvs.addEventListener('touchstart',e=>{isD=true;pPath=[];mv(e)});
        cvs.addEventListener('mousemove',mv); cvs.addEventListener('touchmove',mv); cvs.addEventListener('mouseup',end); cvs.addEventListener('touchend',end); dr();
        function toAuth(){ document.getElementById('screen-loader').style.display='none'; document.getElementById('screen-auth').classList.remove('hidden'); document.getElementById('screen-auth').style.display='flex'; }
    </script>

    <!-- PYTHON LOGIC -->
    <script type="py">
        from pyscript import document
        from pyodide.ffi import create_proxy
        import js, hashlib
        from datetime import datetime

        # STATE
        active_quest = None
        # Tasks: {id, name, done}
        current_tasks = []
        target_task_id = -1

        quests = [
            {"title": "Bridge Repair", "reward": 50000},
            {"title": "Data Analysis", "reward": 20000},
        ]

        def log(msg):
            t = datetime.now().strftime('%H:%M')
            c = document.getElementById("battle-log")
            c.innerHTML = f"<div class='log-line'>[{t}] {msg}</div>" + c.innerHTML

        # AUTH
        def on_sigil_py(name, word, pattern):
            if not name: return
            seed = f"SBCM_{name}_{word}_{pattern}"
            pk_hex = hashlib.sha256(seed.encode()).hexdigest()
            pub = js.js_set_key(pk_hex)
            if pub:
                document.getElementById('screen-auth').classList.add('hidden')
                document.getElementById('screen-main').style.display = 'flex'
                
                # Stats
                val = int(pk_hex[:8], 16)
                document.getElementById('disp-name').innerText = name.upper()
                document.getElementById('disp-job').innerText = "WIZARD" if val%2==0 else "WARRIOR"
                document.getElementById('st-str').innerText = (val%10)+1
                document.getElementById('st-int').innerText = ((val>>4)%10)+1
                document.getElementById('st-dex').innerText = ((val>>8)%10)+1
                
                render_quests()

        js.window.onSigil = create_proxy(on_sigil_py)

        # QUEST LIST
        def render_quests():
            c = document.getElementById("quest-list")
            c.innerHTML = ""
            for q in quests:
                div = document.createElement("div")
                div.className = "quest-card"
                div.innerHTML = f"{q['title']} <span class='quest-reward'>¬•{q['reward']:,}</span>"
                div.onclick = lambda e, t=q['title']: init_dungeon(t)
                c.appendChild(div)

        def add_demo_quest(e):
            quests.insert(0, {"title": "New Mission", "reward": 10000})
            render_quests()

        # DUNGEON LOGIC
        def init_dungeon(title):
            global active_quest, current_tasks
            active_quest = title
            # Generate Tasks (Enemies)
            current_tasks = [
                {"id":0, "name": "SURVEY AREA (Ë™øÊüª)", "done": False},
                {"id":1, "name": "EXECUTION (ÂÆü‰ΩúÊ•≠)", "done": False},
                {"id":2, "name": "REPORTING (Â†±Âëä)", "done": False}
            ]
            
            document.getElementById('view-qlist').classList.add('hidden')
            document.getElementById('view-dungeon').classList.remove('hidden')
            document.getElementById('dun-title').innerText = title
            render_tasks()
            log(f"MISSION START: {title}")

        def render_tasks():
            c = document.getElementById("task-list")
            c.innerHTML = ""
            done_cnt = 0
            for t in current_tasks:
                div = document.createElement("div")
                status = ""
                if t["done"]:
                    div.className = "enemy-row defeated"
                    status = "[DEFEATED]"
                    done_cnt += 1
                else:
                    div.className = "enemy-row"
                    status = "[ALIVE]"
                    # Click to attack
                    div.onclick = lambda e, tid=t["id"], nm=t["name"]: open_report(tid, nm)
                
                div.innerHTML = f"<span>{t['name']}</span><span>{status}</span>"
                c.appendChild(div)
            
            # Update Progress Bar
            pct = int((done_cnt / len(current_tasks)) * 100)
            document.getElementById("dun-hp").style.width = f"{pct}%"
            document.getElementById("dun-pct").innerText = pct
            
            if pct >= 100:
                document.getElementById("btn-claim").style.display = "block"
                log("BOSS DEFEATED. CLAIM REWARD.")

        def open_report(tid, name):
            global target_task_id
            target_task_id = tid
            document.getElementById('rep-task-name').innerText = f"TARGET: {name}"
            document.getElementById('rep-msg').value = ""
            document.getElementById('report-overlay').style.display = 'flex'

        async def submit_report(e):
            global current_tasks
            msg = document.getElementById('rep-msg').value
            if not msg: msg = "No details"
            
            # Mark as done
            current_tasks[target_task_id]["done"] = True
            document.getElementById('report-overlay').style.display = 'none'
            
            render_tasks()
            log(f"HIT! {current_tasks[target_task_id]['name']} -> {msg}")
            
            # Send to Nostr
            await js.js_pub(1, f"PROGRESS: {active_quest}\nTASK:{target_task_id} DONE\nNOTE:{msg}", [["t","SBCM_PROG"]])

        def exit_dungeon(e):
            document.getElementById('view-dungeon').classList.add('hidden')
            document.getElementById('view-qlist').classList.remove('hidden')

        async def claim_reward(e):
            await js.js_pub(1, f"CLAIM: {active_quest} COMPLETE", [["t","SBCM_CLAIM"]])
            log("REWARD CLAIMED. TX SENT.")
            js.alert("QUEST COMPLETE!\nReward sent to The Heart.")
            exit_dungeon(None)

        # COMMS
        async def send_sig(sig):
            log(f"SIGNAL: {sig}")
            await js.js_pub(1, f"SIG: {sig}", [["t","SBCM_SIG"]])

        # AUDIT
        async def audit(e):
            try:
                b=float(document.getElementById("a-b").value)
                u=float(document.getElementById("a-u").value)
                d = b/30000000/(u/72000) if u else 0
                document.getElementById("a-res").innerText = f"D: {d:.1f}"
                await js.js_pub(1, f"AUDIT D:{d}", [["t","SBCM"]])
            except: pass

        toAuth() # Start
    </script>
  </body>
</html>
