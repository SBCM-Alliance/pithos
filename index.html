<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pithos | Sigil Access</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg: #000; --fg: #fff; --dim: #444; }
        body { background: var(--bg); color: var(--fg); font-family: 'JetBrains Mono', monospace; margin: 0; padding: 0; height: 100vh; overflow: hidden; user-select: none; }

        /* --- SCREEN 1: THE VOID --- */
        #screen-void {
            display: flex; align-items: center; justify-content: center; height: 100%;
            font-size: 1.5rem; cursor: pointer; animation: blink 2s infinite;
        }

        /* --- SCREEN 2: AUTH --- */
        #screen-auth {
            display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%;
            padding: 20px; box-sizing: border-box;
        }
        
        .input-group { width: 100%; max-width: 300px; margin-bottom: 30px; }
        label { display: block; font-size: 0.8rem; color: var(--dim); margin-bottom: 5px; }
        input {
            width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--fg);
            color: var(--fg); font-family: inherit; font-size: 1.2rem; padding: 5px; outline: none; border-radius: 0;
        }
        input::placeholder { color: #333; }

        /* PATTERN LOCK (SIGIL) */
        #pattern-container { position: relative; width: 300px; height: 300px; touch-action: none; }
        canvas { position: absolute; top: 0; left: 0; }

        /* --- SCREEN 3: TERMINAL --- */
        #screen-term {
            display: none; padding: 20px; height: 100%; overflow-y: auto; font-size: 14px;
        }
        .line { margin-bottom: 5px; white-space: pre-wrap; word-break: break-all; }
        .prompt { color: var(--fg); font-weight: bold; margin-right: 10px; }
        #cmd { background: transparent; border: none; color: var(--fg); font-family: inherit; font-size: inherit; flex: 1; outline: none; width: 80%; }

        /* Utils */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .hidden { display: none !important; }
    </style>

    <script>
        // Nostr Bridge
        let sk=null; let pk=null; const relays=['wss://relay.damus.io','wss://nos.lol'];
        function js_set_key(hex){ try{sk=hex; pk=window.NostrTools.getPublicKey(sk); return pk;}catch(e){return null;} }
        async function js_pub(k,c,t){ if(!sk)return "NO_AUTH"; const e={kind:k,pubkey:pk,created_at:Math.floor(Date.now()/1000),tags:t,content:c}; e.id=window.NostrTools.getEventHash(e); e.sig=window.NostrTools.signEvent(e,sk); const p=new window.NostrTools.SimplePool(); p.publish(relays,e); return e.id; }
    </script>
</head>
<body>

    <!-- 1. VOID -->
    <div id="screen-void" onclick="toAuth()">
        &gt; login:<span style="width:10px; background:white; display:inline-block; margin-left:5px;">&nbsp;</span>
    </div>

    <!-- 2. AUTH (Name + Word + Sigil) -->
    <div id="screen-auth">
        <div class="input-group">
            <label>NAME (名前)</label>
            <input type="text" id="in-name" autocomplete="off">
        </div>
        <div class="input-group">
            <label>WORD (信念)</label>
            <input type="text" id="in-word" autocomplete="off">
        </div>
        
        <div style="margin-bottom:10px; font-size:0.8rem; color:#666;">DRAW YOUR SIGIL (印を結べ)</div>
        
        <div id="pattern-container">
            <canvas id="lock-canvas" width="300" height="300"></canvas>
        </div>
    </div>

    <!-- 3. TERMINAL -->
    <div id="screen-term">
        <div class="line">PITHOS OS [ONLINE]</div>
        <div class="line">------------------</div>
        <div id="history"></div>
        <div style="display:flex;">
            <span class="prompt" id="prompt-txt">&gt;</span>
            <input type="text" id="cmd" autocomplete="off">
        </div>
    </div>

    <!-- PATTERN LOCK LOGIC (JS) -->
    <script>
        let patternPath = [];
        let isDrawing = false;
        const canvas = document.getElementById('lock-canvas');
        const ctx = canvas.getContext('2d');
        const dots = [];
        
        // Grid Config
        const gridSize = 3;
        const padding = 50;
        const spacing = 100;

        // Init Dots
        for(let r=0; r<gridSize; r++){
            for(let c=0; c<gridSize; c++){
                dots.push({ x: padding + c*spacing, y: padding + r*spacing, id: r*3+c });
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Connections
            if (patternPath.length > 1) {
                ctx.beginPath();
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#fff';
                ctx.moveTo(dots[patternPath[0]].x, dots[patternPath[0]].y);
                for (let i = 1; i < patternPath.length; i++) {
                    ctx.lineTo(dots[patternPath[i]].x, dots[patternPath[i]].y);
                }
                ctx.stroke();
            }

            // Draw Dots
            dots.forEach(d => {
                ctx.beginPath();
                // Highlight active dots
                if (patternPath.includes(d.id)) {
                    ctx.fillStyle = '#fff';
                    ctx.arc(d.x, d.y, 8, 0, Math.PI*2);
                } else {
                    ctx.fillStyle = '#333';
                    ctx.arc(d.x, d.y, 4, 0, Math.PI*2);
                }
                ctx.fill();
            });
        }

        function getDot(x, y) {
            return dots.find(d => Math.hypot(d.x - x, d.y - y) < 30);
        }

        function start(e) {
            isDrawing = true;
            patternPath = [];
            process(e);
        }

        function move(e) {
            if (!isDrawing) return;
            e.preventDefault(); // Stop scroll
            process(e);
        }

        function process(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            const dot = getDot(x, y);
            if (dot && !patternPath.includes(dot.id)) {
                patternPath.push(dot.id);
                draw();
            }
        }

        function end() {
            if (!isDrawing) return;
            isDrawing = false;
            
            if (patternPath.length >= 4) { // Minimum 4 dots
                // Pass to Python
                const name = document.getElementById('in-name').value;
                const word = document.getElementById('in-word').value;
                const patternStr = patternPath.join("-");
                
                if(name && word){
                    // Call Python function (via hidden button or event dispatch)
                    window.onLoginTrigger(name, word, patternStr);
                } else {
                    alert("NAMEとWORDを入力してください");
                    patternPath = []; draw();
                }
            } else {
                patternPath = []; draw(); // Reset if too short
            }
        }

        // Event Listeners
        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', move);
        canvas.addEventListener('mouseup', end);
        
        canvas.addEventListener('touchstart', start);
        canvas.addEventListener('touchmove', move);
        canvas.addEventListener('touchend', end);

        // Initial Draw
        draw();

        // UI Transition
        function toAuth() {
            document.getElementById('screen-void').classList.add('hidden');
            document.getElementById('screen-auth').style.display = 'flex';
            document.getElementById('in-name').focus();
        }
    </script>

    <!-- PYTHON LOGIC -->
    <script type="py">
        from pyscript import document
        from pyodide.ffi import create_proxy
        import js
        import hashlib
        import asyncio

        state = {"user": None}

        # --- AUTH LOGIC ---
        def login_handler(name, word, pattern):
            # THE RITUAL: Name + Word + Sigil = Key
            seed = f"PITHOS_SIGIL_{name}_{word}_{pattern}"
            pk_hex = hashlib.sha256(seed.encode('utf-8')).hexdigest()
            
            pub = js.js_set_key(pk_hex)
            if pub:
                state["user"] = name
                # Transition to Terminal
                document.getElementById('screen-auth').style.display = 'none'
                document.getElementById('screen-term').style.display = 'block'
                
                print_ln(f"IDENTITY GENERATED: {name.upper()}")
                print_ln(f"SIGIL ACCEPTED: {pattern}")
                print_ln(f"KEY: {pub[:16]}...")
                set_prompt(f"{name}@PITHOS:~#")
                document.getElementById("cmd").focus()

        # Bind JS trigger to Python function
        js.window.onLoginTrigger = create_proxy(login_handler)

        # --- TERMINAL LOGIC ---
        def print_ln(text):
            h = document.getElementById("history")
            d = document.createElement("div")
            d.className = "line"
            d.innerText = text
            h.appendChild(d)
            # Auto scroll
            term = document.getElementById("screen-term")
            term.scrollTop = term.scrollHeight

        def set_prompt(t): document.getElementById("prompt-txt").innerText = t

        async def on_enter(e):
            if e.key != "Enter": return
            val = e.target.value.strip()
            e.target.value = ""
            print_ln(f"{document.getElementById('prompt-txt').innerText} {val}")
            
            if val == "clear":
                document.getElementById("history").innerHTML = ""
                return
                
            parts = val.split(" ")
            cmd = parts[0].lower()

            if cmd == "audit":
                try:
                    b = float(parts[1]); u = float(parts[2]); t = " ".join(parts[3:])
                    if u==0: u=1
                    d = b / 30000000 / (u / 72000)
                    res = "SAFE" if d < 10 else "SCAM"
                    print_ln(f"AUDITING {t}...")
                    print_ln(f"D_INDEX: {d:.2f} -> {res}")
                    eid = await js.js_pub(1, f"AUDIT: {t}\nD:{d:.1f}\n#{res}", [["t","SBCM"]])
                    print_ln(f"BROADCAST: {eid[:8]}")
                except: print_ln("ERR: audit [yen] [ppl] [name]")

            elif cmd == "job":
                t = " ".join(parts[1:])
                eid = await js.js_pub(1, f"JOB: {t}\n#SBCM_JOB", [["t","SBCM_JOB"]])
                print_ln(f"JOB POSTED: {eid[:8]}")

            elif cmd == "logout":
                js.location.reload()
            
            else:
                print_ln("UNKNOWN COMMAND. (audit, job, logout)")

        document.getElementById("cmd").onkeypress = create_proxy(on_enter)

    </script>
</body>
</html>
